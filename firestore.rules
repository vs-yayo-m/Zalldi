// firestore.rules

rules_version = '2';
service cloud.firestore {
match /databases/{database}/documents {

function isAuthenticated() {
return request.auth != null;
}

function isOwner(userId) {
return isAuthenticated() && request.auth.uid == userId;
}

function getUserData() {
return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
}

function hasRole(role) {
return isAuthenticated() && getUserData().role == role;
}

function isAdmin() {
return hasRole('admin');
}

function isSupplier() {
return hasRole('supplier');
}

function isCustomer() {
return hasRole('customer');
}

match /users/{userId} {
allow read: if isAuthenticated();
allow create: if isAuthenticated() && isOwner(userId);
allow update: if isOwner(userId) || isAdmin();
allow delete: if isAdmin();
}

match /products/{productId} {
allow read: if true;
allow create: if isSupplier() || isAdmin();
allow update: if isAdmin() ||
(isSupplier() && resource.data.supplierId == request.auth.uid);
allow delete: if isAdmin() ||
(isSupplier() && resource.data.supplierId == request.auth.uid);
}

match /orders/{orderId} {
allow read: if isAuthenticated() &&
(resource.data.customerId == request.auth.uid ||
isSupplier() ||
isAdmin());
allow create: if isAuthenticated() &&
request.resource.data.customerId == request.auth.uid;
allow update: if isSupplier() || isAdmin();
allow delete: if isAdmin();
}

match /reviews/{reviewId} {
allow read: if true;
allow create: if isAuthenticated() &&
request.resource.data.customerId == request.auth.uid;
allow update: if isOwner(resource.data.customerId) || isAdmin();
allow delete: if isOwner(resource.data.customerId) || isAdmin();
}

match /categories/{categoryId} {
allow read: if true;
allow write: if isAdmin();
}

match /carts/{cartId} {
allow read, write: if isOwner(cartId);
}

match /wishlists/{wishlistId} {
allow read, write: if isOwner(wishlistId);
}

match /addresses/{addressId} {
allow read, write: if isAuthenticated() &&
resource.data.userId == request.auth.uid;
}

match /notifications/{notificationId} {
allow read: if isAuthenticated() &&
resource.data.userId == request.auth.uid;
allow write: if isAdmin();
}

match /settings/{settingId} {
allow read: if true;
allow write: if isAdmin();
}

match /analytics/{documentId} {
allow read: if isSupplier() || isAdmin();
allow write: if isAdmin();
}
}
}